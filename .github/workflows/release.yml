name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Create Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  tag_name="${GITHUB_REF#refs/tags/}"
                  echo "Creating release for tag: $tag_name"

                  # Check if release exists, if not create it
                  if ! gh release view "$tag_name" > /dev/null 2>&1; then
                      gh release create "$tag_name" \
                          --title "$tag_name" \
                          --generate-notes \
                          --verify-tag
                  else
                      echo "Release $tag_name already exists"
                  fi

    build-and-upload:
        needs: create-release
        runs-on: ubuntu-latest
        strategy:
            matrix:
                platform:
                    - "windows-x64"
                    - "windows-x64-baseline"
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Build and Upload (${{ matrix.platform }})
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  version=${GITHUB_REF#refs/tags/v}
                  bun run .github/scripts/release.ts build --platform ${{ matrix.platform }} $version

            - name: Upload metadata artifact
              uses: actions/upload-artifact@v4
              with:
                  name: metadata-${{ matrix.platform }}
                  path: artifacts/*.json
                  retention-days: 1

    create-latest-json:
        needs: build-and-upload
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Download metadata artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  pattern: metadata-*
                  merge-multiple: true

            - name: Generate latest.json
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  version=${GITHUB_REF#refs/tags/v}
                  bun run .github/scripts/release.ts json $version

            - name: Upload latest.json
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  version=${GITHUB_REF#refs/tags/v}
                  gh release upload "v${version}" dist/latest.json --clobber
