name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Create Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  tag_name="${GITHUB_REF#refs/tags/}"
                  echo "Creating release for tag: $tag_name"

                  # Check if release exists, if not create it
                  if ! gh release view "$tag_name" > /dev/null 2>&1; then
                      gh release create "$tag_name" \
                          --title "$tag_name" \
                          --generate-notes \
                          --verify-tag
                  else
                      echo "Release $tag_name already exists"
                  fi

    build-and-upload:
        needs: create-release
        runs-on: ubuntu-latest
        strategy:
            matrix:
                variant:
                    - name: "AVX2"
                      suffix: ""
                      build_flag: ""
                    - name: "Baseline"
                      suffix: "-baseline"
                      build_flag: "--baseline"
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Extract version from tag
              id: version
              shell: bash
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Build executable (${{ matrix.variant.name }})
              run: bun run build ${{ matrix.variant.build_flag }}
              env:
                  SWB_VERSION: ${{ steps.version.outputs.VERSION }}

            - name: Create release archive
              run: |
                  version="${{ steps.version.outputs.VERSION }}"
                  suffix="${{ matrix.variant.suffix }}"
                  dirname="swb-v${version}-windows-x64${suffix}"
                  zipname="${dirname}.zip"

                  # Create directory structure
                  mkdir -p "dist/${dirname}"

                  # Copy files into directory
                  cp dist/swb.exe "dist/${dirname}/"
                  cp README.md "dist/${dirname}/"
                  cp LICENSE "dist/${dirname}/"

                  # Create zip with directory structure
                  cd dist
                  zip -r "${zipname}" "${dirname}"

                  # Clean up temporary directory
                  rm -rf "${dirname}"

            - name: Upload to Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  version="${{ steps.version.outputs.VERSION }}"
                  basename="dist/swb-v${version}-windows-x64${{ matrix.variant.suffix }}.zip"

                  echo "Uploading $basename to v$version..."
                  gh release upload "v${version}" "$basename" --clobber

                  # Generate and upload SHA256 checksum
                  sha256name="${basename}.sha256"
                  sha256sum "$basename" | awk '{print $1}' > "$sha256name"
                  echo "Uploading $sha256name to v$version..."
                  gh release upload "v${version}" "$sha256name" --clobber
